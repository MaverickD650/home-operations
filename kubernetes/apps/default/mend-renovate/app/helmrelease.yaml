---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/refs/heads/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mend-renovate
spec:
  chartRef:
    kind: OCIRepository
    name: mend-renovate
  interval: 30m
  timeout: 20m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    global:
      stopAll: false
    image:
      repository: ghcr.io/mend/renovate-ce
      pullPolicy: IfNotPresent
      tag: 13.2.0@sha256:bc02ee795e11931d46f5409fcff1c04e187f3812f0b4b75672f923bf66a543fb

    workload:
      main:
        podSpec:
          containers:
            main:
              envFrom:
                - secretRef:
                    name: mend-rnv-secret
                    expandObjectName: false
              env:
                MEND_RNV_ACCEPT_TOS: "Y"
                # unregistered public license key
                MEND_RNV_LICENSE_KEY: eyJsaW1pdCI6IjEwIn0=.30440220457941b71ea8eb345c729031718b692169f0ce2cf020095fd328812f4d7d5bc1022022648d1a29e71d486f89f27bdc8754dfd6df0ddda64a23155000a61a105da2a1
                MEND_RNV_PLATFORM: github
                # See https://github.com/mend/renovate-ce-ee/blob/main/docs/setup-for-github.md
                MEND_RNV_SERVER_PORT: "{{ .Values.service.main.ports.main.port }}"
                MEND_RNV_AUTODISCOVER_FILTER: "maverickd650/home-operations"
                MEND_RNV_DATA_HANDLER_TYPE: postgresql
                PGDATABASE: "{{ .Values.cnpg.main.database }}"
                PGUSER: "{{ .Values.cnpg.main.user }}"
                PGPASSWORD: "{{ .Values.cnpg.main.creds.password }}"
                PGHOST: "{{ .Values.cnpg.main.creds.host }}"
                PGPORT: "5432"
                LOG_LEVEL: debug

    service:
      main:
        ports:
          main:
            port: 80
            protocol: tcp
    securityContext:
      container:
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
    cnpg:
      main:
        enabled: true
        user: renovate
        database: renovate
        cluster:
          singleNode: true
        backups:
          enabled: false
